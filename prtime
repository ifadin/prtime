#!/usr/bin/env python3

from typing import List

import click
from github import Github

from cli.distribution import analyze_repos
from cli.notrequiredif import NotRequiredIfOpt

BASE_URL = 'https://github.bus.zalan.do/api/v3'
REPOS = ['deploy', 'integrator', 'ci-gooddata-sql', 'gooddata-python', 'dna-tools', 'ci-master-workspace', 'airpipe']
ORGANIZATION = 'dna'


@click.command()
@click.option('-l', '--login', type=click.STRING, help='Github login', required=True,
              cls=NotRequiredIfOpt, not_required_if='auth_token')
@click.option('-pw', '--password', type=click.STRING, help='Github password', required=True,
              cls=NotRequiredIfOpt, not_required_if='auth_token')
@click.option('-t', '--auth-token', type=click.STRING, help='Github authentication token', required=True,
              cls=NotRequiredIfOpt, not_required_if=['login', 'password'])
@click.option('-d', '--days', type=click.INT, help='Limit analysis to last n days')
@click.option('-v', '--verbose', is_flag=True, default=False, help='Print dataset info')
@click.argument('repos', nargs=-1)
def cli(login: str, password: str, auth_token: str, days: int, verbose: bool, repos: List[str]):
    g = get_github_client(BASE_URL, login, password, auth_token)

    repos = list(repos) if repos else REPOS
    time_filter = f'(last {days} days)' if days else ''
    click.echo(f'Calculating for {repos} {time_filter}')

    analyze_repos(g, ORGANIZATION, repos, days, verbose)


def get_github_client(base_url: str, login: str, password: str, token: str):
    return (Github(base_url=base_url, login_or_token=token)
            if token
            else Github(base_url=base_url, login_or_token=login, password=password))


if __name__ == '__main__':
    cli()
